variables:
  GC_ENABLE_BOOTSTRAP: "true"
  GC_SERVICE: partition
  GC_VENDOR: gc
  GC_HELM_ENV_DIR: "devops/gc/tests/env"
  ENV_BUILD_PATH: "devops/gc/tests/build/Dockerfile"

.gc_common_cleanup:
  script:
    - git clone https://community.opengroup.org/osdu/platform/deployment-and-operations/infra-gcp-provisioning.git
    - cp infra-gcp-provisioning/tools/datastore-cleanup/* devops/gc/tests/clean_up/

gc-containerize-bootstrap-env-gitlab:
  stage: build
  image: docker:19.03.15
  tags: ["osdu-small"]
  services:
    - docker:20.10.7-dind
  variables:
    BUILD_BOOTSTRAP_PATH: "devops/gc/tests/build/Dockerfile"
  script:
    - export EXTRA_DOCKER_TAG=""
    - >
      if [[ "$CI_COMMIT_TAG" != "" ]];
      then EXTRA_DOCKER_TAG="-t $CI_REGISTRY_IMAGE/$IMAGE_BOOTSTRAP_NAME-env:$CI_COMMIT_TAG";
      elif [[ "$CI_COMMIT_REF_NAME" = "$CI_DEFAULT_BRANCH" ]];
      then EXTRA_DOCKER_TAG="-t $CI_REGISTRY_IMAGE/$IMAGE_BOOTSTRAP_NAME-env:latest"; fi
    - docker build -t $CI_REGISTRY_IMAGE/$IMAGE_BOOTSTRAP_NAME-env:$CI_COMMIT_SHORT_SHA $EXTRA_DOCKER_TAG -f $BUILD_BOOTSTRAP_PATH .
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    - docker push $CI_REGISTRY_IMAGE/$IMAGE_BOOTSTRAP_NAME-env
  rules:
    - if: "$GC == '1' && $GC_ENABLE_BOOTSTRAP == 'true'"
      when: on_success

gc-deploy: # reuse common deploy job for test deployment
  variables:
    GC_HELM_NAMESPACE: partition-int-test
    GC_HELM_SETS: >-
      --set data.dataPartitionId=test
      --set data.partitionNamespace=partition-test
      --set istio.sidecarInject=false
    GC_SA_EMAIL: $GC_SA_GKE_EMAIL

gc-test:
  variables:
    CLIENT_TENANT: test
    PARTITION_BASE_URL: https://test.community.gcp.gnrg-osdu.projects.epam.com/

gc-cleanup-env: # clean-up env after tests
  environment:
    name: Google_Cloud
  stage: cleanup
  extends: .gc-variables
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://iam.googleapis.com/projects/${GC_PROJECT_NUMBER}/locations/global/workloadIdentityPools/${GC_POOL_ID}/providers/${GC_PROVIDER_ID}
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:alpine
  needs: ["gc-test"]
  tags: ["osdu-small"]
  variables:
    PARTITION_NAMESPACE: partition-test
    GC_HELM_NAMESPACE: partition-int-test
    GC_SA_EMAIL: $GC_SA_GKE_EMAIL
  script:
    - !reference [.gc_obtain_credentials, script]
    - !reference [.gc_common_config, script]
    - !reference [.gc_common_cleanup, script]
    - chmod +x devops/gc/tests/clean_up/clean_up.sh && devops/gc/tests/clean_up/clean_up.sh --all
  rules:
    - if: "$CI_COMMIT_BRANCH =~ /^release/"
      when: never
    - if: "$CI_COMMIT_TAG"
      when: never
    - if: '$GC == "1"'
      when: always

gc-verified-deploy: # verified deploy after tests
  extends: gc-deploy
  stage: verified-deploy
  needs: ["gc-test"]
  variables:
    GC_HELM_NAMESPACE: default
    GC_TENANT: osdu
    # GC_HELM_SETS is blanked since values from gc-deploy is not compatible
    GC_HELM_SETS: ""

gc-dev2-deploy: # reuse common deploy job for test deployment
  variables:
    GC_HELM_NAMESPACE: partition-int-test
    GC_HELM_SETS: >-
      --set data.dataPartitionId=test
      --set data.partitionNamespace=partition-test
      --set istio.sidecarInject=false
    GC_SA_EMAIL: $GC_SA_GKE_EMAIL

gc-dev2-test:
  variables:
    CLIENT_TENANT: test
    PARTITION_BASE_URL: https://test.dev2.gcp.gnrg-osdu.projects.epam.com/

gc-dev2-cleanup-env: # clean-up env after tests
  environment:
    name: GC_Dev2
  stage: cleanup
  extends: .gc-dev2-variables
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://iam.googleapis.com/projects/${GC_PROJECT_NUMBER}/locations/global/workloadIdentityPools/${GC_POOL_ID}/providers/${GC_PROVIDER_ID}
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:alpine
  needs: [gc-dev2-test]
  tags: ["osdu-small"]
  variables:
    PARTITION_NAMESPACE: partition-test
    GC_HELM_NAMESPACE: partition-int-test
    GC_SA_EMAIL: $GC_SA_GKE_EMAIL
  script:
    - !reference [.gc_obtain_credentials, script]
    - !reference [.gc_common_config, script]
    - !reference [.gc_common_cleanup, script]
    - chmod +x devops/gc/tests/clean_up/clean_up.sh && devops/gc/tests/clean_up/clean_up.sh --all
  rules:
    - if: '$GC == "1" && $CI_COMMIT_BRANCH =~ /^release/'
      when: always
    - if: '$GC == "1" && $CI_COMMIT_TAG'
      when: always

gc-dev2-verified-deploy: # verified deploy after tests
  extends: gc-dev2-deploy
  stage: verified-deploy
  needs: ["gc-dev2-test"]
  retry: 1
  variables:
    GC_SA_EMAIL: $GC_SA_GKE_EMAIL
    GC_HELM_NAMESPACE: default
    GC_TENANT: devtwo
    GC_HELM_SETS: ""

gc-preship-deploy:
  extends: .gc-preship-variables
  tags: ["osdu-small"]
  image: gcr.io/google.com/cloudsdktool/cloud-sdk:alpine
  stage: deploy_preship
  needs: ["gc-dev2-verified-deploy", "gc-dev2-test"]
